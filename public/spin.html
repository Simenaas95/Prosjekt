<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin the Wheel</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>Spin the Wheel</h1>
        
        <!-- Wheel Creation Form -->
        <div class="form-group">
            <h2>Create New Wheel</h2>
            <input type="text" id="wheelName" placeholder="Wheel Name">
            <input type="text" id="prizeName" placeholder="Prize Name">
            <button onclick="addPrize()">Add Prize</button>
            <button onclick="createWheel()">Create Wheel</button>
            <ul id="prizeList"></ul>
        </div>

        <!-- Wheel Display -->
        <div class="wheel-container">
            <div class="pointer"></div>
            <div class="wheel" id="wheel"></div>
        </div>
        
        <div id="result"></div>
        <button onclick="spinWheel()" id="spinButton">Spin!</button>
    </div>

    <script>
        let currentPrizes = [];
        let currentWheelId = null;

        async function addPrize() {
            const prize = document.getElementById('prizeName').value.trim();
            if (prize) {
                currentPrizes.push(prize);
                document.getElementById('prizeName').value = '';
                updatePrizeList();
                updateWheel();
                document.querySelector('.pointer').style.display = 'block'; // Show pointer
            }
        }

        function updatePrizeList() {
            const list = document.getElementById('prizeList');
            list.innerHTML = currentPrizes.map(prize => 
                `<li>${prize}</li>`
            ).join('');
        }

        function updateWheel() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';
            
            if (currentPrizes.length === 0) return;

            // Calculate segment size
            const segmentAngle = 360 / currentPrizes.length;
            
            // Create background gradient
            const gradientStops = currentPrizes.map((prize, index) => {
                const startAngle = index * segmentAngle;
                const endAngle = (index + 1) * segmentAngle;
                const color = `hsl(${index * (360 / currentPrizes.length)}, 70%, 50%)`;
                return `${color} ${startAngle}deg ${endAngle}deg`;
            }).join(', ');
            
            wheel.style.background = `conic-gradient(${gradientStops})`;

            // Add text segments
            currentPrizes.forEach((prize, index) => {
                const segment = document.createElement('div');
                segment.className = 'segment';
                
                const text = document.createElement('div');
                text.className = 'segment-text';
                text.textContent = prize;
                text.style.transform = `rotate(${index * segmentAngle + segmentAngle/2}deg)`;
                
                segment.appendChild(text);
                wheel.appendChild(segment);
            });
        }

        async function createWheel() {
            const name = document.getElementById('wheelName').value;
            if (name && currentPrizes.length > 0) {
                const wheelData = {
                    name: name,
                    options: currentPrizes,
                    settings: {
                        defaultPrize: 'Try Again',
                        minSpinTime: 3,
                        maxSpinTime: 8,
                        isActive: true
                    }
                };

                try {
                    const response = await fetch('/api/wheels', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(wheelData)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create wheel');
                    }

                    const data = await response.json();
                    currentWheelId = data.id;
                    alert('Wheel created successfully!');
                } catch (error) {
                    console.error('Error creating wheel:', error);
                }
            } else {
                alert('Please enter a wheel name and add at least one prize.');
            }
        }

        async function spinWheel() {
            const wheel = document.getElementById('wheel');
            const resultElement = document.getElementById('result');
            const spinButton = document.getElementById('spinButton');
            
            // Disable the spin button
            spinButton.disabled = true;
            
            try {
                const segmentAngle = 360 / currentPrizes.length;
                const randomSegment = Math.floor(Math.random() * currentPrizes.length);
                const randomExtraRotation = Math.random() * segmentAngle; // Random extra rotation within one segment
                const finalRotation = -360 * (5 + Math.random() * 2) - randomSegment * segmentAngle - randomExtraRotation; // 5-7 full rotations counterclockwise
                
                wheel.style.transition = 'transform 3s cubic-bezier(0.2, 0.8, 0.3, 1)';
                wheel.style.transform = `rotate(${finalRotation}deg)`;
                
                setTimeout(() => {
                    const normalizedRotation = (finalRotation % 360 + 360) % 360; // Normalize rotation to 0-360 degrees
                    const actualSegment = Math.floor(normalizedRotation / segmentAngle);
                    resultElement.textContent = `Result: ${currentPrizes[actualSegment]}`;
                    // Re-enable the spin button
                    spinButton.disabled = false;
                }, 3000);
            } catch (error) {
                console.error('Error spinning wheel:', error);
                // Re-enable the spin button in case of error
                spinButton.disabled = false;
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(reg => console.log('Service Worker registered:', reg))
                .catch(err => console.log('Service Worker registration failed:', err));
        }
    </script>
</body>
</html>
